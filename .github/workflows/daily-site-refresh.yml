jobs:
  refresh:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed so we can commit the PNG

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # --- FIX: install the package so `require('playwright')` works
      - name: Install Playwright package
        run: |
          npm init -y
          npm i playwright@^1.47.0

      # --- FIX: install the Chromium browser binaries and OS deps
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Snapshot Finviz heatmap → docs/snapshots/heatmap-snapshot.png
        shell: bash
        run: |
          node - <<'JS'
          const fs = require('fs');
          const path = require('path');
          const { chromium } = require('playwright');

          (async () => {
            const outDir  = path.join('docs', 'snapshots');
            const outFile = path.join(outDir, 'heatmap-snapshot.png');
            fs.mkdirSync(outDir, { recursive: true });

            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox','--disable-setuid-sandbox']
            });
            const ctx = await browser.newContext({
              viewport: { width: 1600, height: 1100 },
              userAgent:
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123 Safari/537.36'
            });

            // Block ad/analytics noise that prevents “networkidle”
            await ctx.route('**/*', (route) => {
              const u = route.request().url();
              const block = [
                'doubleclick','googlesyndication','googletagmanager',
                'adservice.google','analytics','scorecardresearch','facebook'
              ].some(s => u.includes(s));
              if (block) return route.abort();
              route.continue();
            });

            const page = await ctx.newPage();
            try {
              await page.goto('https://finviz.com/map.ashx', { waitUntil: 'load', timeout: 120000 });

              // Try to accept cookie banners
              try {
                const btn = await page.waitForSelector(
                  'button:has-text("Agree"), button:has-text("I Agree"), #onetrust-accept-btn-handler',
                  { timeout: 5000 }
                );
                if (btn) await btn.click();
              } catch {}

              await page.waitForSelector('canvas, img[src*="map.ashx"], .f-map, #map, #root', { timeout: 60000 });
              await page.waitForTimeout(2500);
              await page.screenshot({ path: outFile, fullPage: true });
              console.log('Wrote:', outFile);
            } catch (e) {
              console.error('Heatmap snapshot failed:', e);
              process.exitCode = 1;
            } finally {
              await browser.close();
            }
          })();
          JS

      - name: Commit updated snapshot
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/snapshots/heatmap-snapshot.png
          git commit -m "Update heatmap snapshot" || echo "No changes to commit"
          git push
