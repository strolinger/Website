
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Trolinger & Associates — Market Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0c10; --card:#14161a; --muted:#9aa4ad; --text:#e8eef2;
    --accent:#2dd4bf; --red:#ef4444; --green:#10b981; --border:#20242b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:#8dd3ff;text-decoration:none} a:hover{text-decoration:underline}

  header{position:sticky;top:0;z-index:50;background:rgba(11,12,16,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .nav{max-width:1200px;margin:0 auto;display:flex;gap:16px;align-items:center;padding:10px 16px}
  .nav .brand{font-weight:700;letter-spacing:.3px}
  .nav a.tab{padding:6px 10px;border-radius:8px;border:1px solid transparent}
  .nav a.tab:hover{border-color:var(--border);background:#101216}
  #lastUpdated{color:var(--muted);margin-left:auto;font-size:.92rem}

  main{max-width:1200px;margin:18px auto;padding:0 16px}
  section[id]{scroll-margin-top:78px;} /* <— fixes misaligned anchor jumps under sticky header */

  /* Ticker */
  .ticker-wrap{overflow:hidden;white-space:nowrap;border:1px solid var(--border);background:#0f1116;border-radius:10px}
  .ticker{display:inline-block;padding:8px 0;animation:scroll 40s linear infinite}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;margin:0 8px;border-radius:999px;background:#0c0e13;border:1px solid #1a2030}
  .chip .pct.up{color:var(--green)} .chip .pct.down{color:var(--red)}
  @keyframes scroll{from{transform:translateX(0)} to{transform:translateX(-50%)}}

  /* Cards / grids */
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{margin:.2rem 0 .6rem;font-size:1.15rem}
  .muted{color:var(--muted);font-size:.92rem}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media (max-width:980px){.grid2,.grid3{grid-template-columns:1fr}}

  /* Tables */
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
  th{color:#b8c4cc;font-weight:600}

  /* Snapshots */
  .snapshot{width:100%;max-height:780px;object-fit:contain;background:#0e1015;border:1px solid var(--border);border-radius:10px}

  /* Winners/Losers colors */
  .ok{color:var(--green)} .bad{color:var(--red)}

  /* News bullets + collapsible detail */
  .news-bullets ul{margin:.3rem 0 0 1.1rem;padding:0}
  .news-bullets li{margin:.32rem 0; list-style: disc;}
  .news-item{cursor:pointer}
  .news-item .meta{color:var(--muted); font-size:.85rem; margin-left:.4rem}
  .collapse{max-height:0; overflow:hidden; transition:max-height .22s ease}
  .collapse.open{max-height:220px}
  .news-detail{border-left:2px solid var(--border); margin:.25rem 0 .5rem 1rem; padding:.45rem .6rem; background:#10141b;border-radius:8px}
</style>
</head>
<body>
<header>
  <nav class="nav">
    <div class="brand">Trolinger &amp; Associates</div>
    <a class="tab" href="#calendar-today">Economic Calendar</a>
    <a class="tab" href="#winners-losers">Winners &amp; Losers</a>
    <a class="tab" href="#heatmap">Heat Map</a>
    <a class="tab" href="#news">Big Cap News</a>
    <div id="lastUpdated"></div>
  </nav>
</header>

<main>
  <!-- Big Cap Ticker -->
  <section aria-label="Big Cap Ticker" style="margin:8px 0 18px">
    <div class="ticker-wrap">
      <div id="ticker1" class="ticker"></div>
      <div id="ticker2" class="ticker" aria-hidden="true"></div>
    </div>
    <div class="muted" style="margin-top:6px">
      Reads <code>ticker-prices.json</code> if present. Otherwise shows placeholders.
    </div>
  </section>

  <!-- ECONOMIC CALENDAR (TODAY) — now at the top -->
  <section id="calendar-today" class="card" style="margin-top:12px">
    <h2>Economic Calendar — Today</h2>
    <div id="calendarToday"></div>
    <div class="muted" style="margin-top:8px">
      <a target="_blank" href="https://www.marketwatch.com/economy-politics/calendar">Open full MarketWatch calendar →</a>
    </div>
  </section>

  <!-- Winners / Losers -->
  <section id="winners-losers" class="grid2" style="margin-top:16px">
    <div class="card">
      <h2>Top Winners</h2>
      <table id="tbl-winners"><thead><tr><th>Symbol</th><th>Name</th><th>Price</th><th>%</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h2>Top Losers</h2>
      <table id="tbl-losers"><thead><tr><th>Symbol</th><th>Name</th><th>Price</th><th>%</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- HEAT MAP — full width with links below -->
  <section id="heatmap" class="card" style="margin-top:16px">
    <h2>Market Heat Map</h2>
    <img id="heatmap-img"
     src="snapshots/finviz-heatmap.png"
     alt="Finviz Heatmap snapshot"
     style="max-width:100%;height:auto;" />
    <div class="muted" style="margin-top:8px;display:flex;gap:18px;flex-wrap:wrap">
      <a target="_blank" href="https://finviz.com/map.ashx">Open Heat Map Index →</a>
      <a target="_blank" href="https://money.cnn.com/data/fear-and-greed/">Open Fear &amp; Greed Index →</a>
    </div>
  </section>

  <!-- Big Cap News — 3 columns, alphabetized tickers -->
  <section id="news" class="card" style="margin-top:16px">
    <h2>Big Cap News</h2>
    <div id="news-grid" class="grid3"></div>
    <div class="muted" style="margin-top:6px">Bullet headlines; click to expand details. Reads local <code>news-*.json</code>.</div>
  </section>

  <footer class="muted" style="margin:24px 0 10px">Snapshots &amp; data are generated around 6:00am by local scripts.</footer>
</main>

<script>
const BIG_CAPS = ["AAPL","AMD","AMZN","BA","BABA","COST","DIS","GOOGL","INTC","IWM","META","MSFT","MU","NFLX","NVDA","TSLA","TXN","WDAY"];
const SORTED = [...BIG_CAPS].sort();
document.getElementById('lastUpdated').textContent = 'Last updated ' + new Date().toLocaleString();

/* Smooth scroll (still useful, but CSS scroll-margin-top handles the stop position) */
document.querySelectorAll('a.tab').forEach(a=>{
  a.addEventListener('click',e=>{
    e.preventDefault();
    const el = document.querySelector(a.getAttribute('href'));
    el && el.scrollIntoView({behavior:'smooth',block:'start'});
  });
});

async function loadJSON(path){
  try{ const r=await fetch(path,{cache:'no-cache'}); if(!r.ok) throw 0; return await r.json(); }
  catch{ return null; }
}

/* ---------- Ticker ---------- */
async function renderTicker(){
  // NEW: cache-busted fetch so the browser always grabs the latest file
  let data = await loadJSON('ticker-prices.json?v=' + Date.now());

  if(!Array.isArray(data) || !data.length){
    data = SORTED.map(s=>({symbol:s,price:'',changePct:''}));
  }
  const line = data.map(x=>{
    const pct = (x.changePct ?? '').toString();
    const cls = pct.startsWith('+') ? 'pct up' : (pct.startsWith('-') ? 'pct down' : 'pct');
    return `<span class="chip"><span>${x.symbol}</span><span>${x.price??''}</span><span class="${cls}">${pct}</span></span>`;
  }).join(' ') + ' ';
  document.getElementById('ticker1').innerHTML = line + line;
  document.getElementById('ticker2').innerHTML = line + line;
}

/* ---------- Winners / Losers ---------- */
function rowsFrom(arr,neg=false){
  if(!Array.isArray(arr) || !arr.length) return '<tr><td colspan="4" class="muted">No data</td></tr>';
  return arr.map(o=>{
    const pct = o.changePct ?? '';
    const cls = String(pct).startsWith('-') || neg ? 'bad' : 'ok';
    return `<tr><td>${o.symbol||''}</td><td>${o.name||''}</td><td>${o.price||''}</td><td class="${cls}">${pct}</td></tr>`;
  }).join('');
}
async function renderWinnersLosers(){
  const w = await loadJSON('winners.json');
  const l = await loadJSON('losers.json');
  document.querySelector('#tbl-winners tbody').innerHTML = rowsFrom(w||[]);
  document.querySelector('#tbl-losers tbody').innerHTML = rowsFrom(l||[], true);
}

/* ---------- Economic Calendar (TODAY) ---------- */
async function renderCalendarToday(){
  const el = document.getElementById('calendarToday');
  const data = await loadJSON('calendar-today.json');  // new file written by the updater
  if(!Array.isArray(data) || !data.length){ el.innerHTML='<div class="muted">No entries for today.</div>'; return; }
  const rows = data.map(it=>`
    <tr>
      <td>${it.time||''}</td>
      <td>${it.release||it.event||''}</td>
      <td>${it.period||''}</td>
      <td>${it.actual||''}</td>
      <td>${it.median||it.forecast||''}</td>
      <td>${it.previous||''}</td>
    </tr>`).join('');
  el.innerHTML = `<table>
    <thead><tr><th>Time</th><th>Release</th><th>Period</th><th>Actual</th><th>Forecast / Median</th><th>Previous</th></tr></thead>
    <tbody>${rows}</tbody></table>`;
}

/* ---------- Big Cap News (3 columns, alphabetized) ---------- */
function buildTickerNews(ticker, articles){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `<h3 style="margin:.1rem 0 .4rem">${ticker}</h3>
                    <div class="news-bullets" id="nb-${ticker}"></div>`;
  const host = card.querySelector('.news-bullets');

  if(!articles || !articles.length){ host.innerHTML = `<p class="muted">No recent articles.</p>`; return card; }

  const ul = document.createElement('ul'); host.appendChild(ul);
  articles.slice(0,3).forEach((it, idx)=>{
    const li = document.createElement('li'); li.className='news-item';
    const title = (it.title || 'Untitled').trim();
    const link = it.link || '#';
    const when = (it.published || '').replace(' +0000','');
    let hostName=''; try{ hostName = new URL(link).hostname; }catch{}
    li.innerHTML = `
      <span class="headline">${title}</span>
      ${when ? `<span class="meta">· ${when}</span>`:''}
      <div class="collapse" id="nd-${ticker}-${idx}">
        <div class="news-detail">
          <div style="margin-bottom:.35rem"><a href="${link}" target="_blank" rel="noopener">Open article →</a></div>
          <div class="muted">Source: <span>${hostName || 'link'}</span></div>
        </div>
      </div>`;
    li.addEventListener('click', e=>{
      if(e.target.tagName.toLowerCase()==='a') return;
      li.querySelector('.collapse').classList.toggle('open');
    });
    ul.appendChild(li);
  });
  return card;
}
async function renderNews(){
  const grid = document.getElementById('news-grid');
  grid.innerHTML = '';
  for(const t of SORTED){
    const data = await loadJSON(`news-${t.toLowerCase()}.json`) || [];
    grid.appendChild(buildTickerNews(t, data));
  }
}

/* ---------- Init ---------- */
renderTicker();
renderWinnersLosers();
renderCalendarToday();
renderNews();

// NEW: refresh ticker every 60 seconds
setInterval(renderTicker, 60000);

 // === Heat map refresh ===
  function refreshHeatmap() {
    const img = document.getElementById('heatmap-img');
    if (img) {
      // Cache-bust so the newest PNG is used
      img.src = 'snapshots/finviz-heatmap.png?v=' + Date.now();
    }
  }

  // Call it on page load
  refreshHeatmap();

  // Optional: also refresh when you return to the tab
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) refreshHeatmap();
  });

  // Optional: refresh every 5 minutes
  // setInterval(refreshHeatmap, 5 * 60 * 1000);  
</script>
</body>
</html>
