<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trolinger & Associates — Market Dashboard</title>

  <style>
    :root{
      --bg:#0f1115;
      --card:#151922;
      --muted:#9aa3b2;
      --text:#e6ebf5;
      --chip:#1e2430;
      --chip-border:#2a3241;
      --up:#26c281;
      --down:#ff5c5c;
      --link:#6db8ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    header{padding:16px 20px;border-bottom:1px solid #1a2030;background:linear-gradient(0deg,#10131a,#0e1117)}
    header h1{margin:0;font-size:18px}
    header small{color:var(--muted)}
    main{padding:18px;max-width:1200px;margin:0 auto}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .card{
      background:var(--card);
      border:1px solid #1e2636;
      border-radius:12px;
      padding:16px;
      width:100%;
    }
    h2{margin:0 0 10px 0;font-size:18px}
    .muted{color:var(--muted)}

    /* ticker chips */
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      background:var(--chip);
      border:1px solid var(--chip-border);
      color:var(--text);
      padding:8px 12px;
      border-radius:18px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:84px;
      justify-content:space-between;
      box-shadow:0 0 0 1px rgba(0,0,0,.08) inset;
    }
    .sym{opacity:.9;font-weight:600;letter-spacing:.2px}
    .price{opacity:.95}
    .pct{font-weight:600}
    .up{color:var(--up)}
    .down{color:var(--down)}
    .flat{color:var(--muted)}

    /* heat map image */
    #heatmap-img{max-width:100%;height:auto;border-radius:8px;border:1px solid #232c3e}
    .links{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
    .links a{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <h1>Trolinger &amp; Associates <small id="last-updated" class="muted"></small></h1>
  </header>

  <main>
    <!-- TICKER STRIP -->
    <section class="card">
      <h2 style="margin-bottom:6px">Tickers</h2>
      <div id="ticker-strip" class="chips" aria-live="polite"></div>
      <div class="muted" style="margin-top:8px">
        Reads <code>ticker-prices.json</code> if present. Otherwise shows placeholders.
      </div>
    </section>

    <!-- HEAT MAP -->
    <section class="card" style="margin-top:18px">
      <h2>Market Heat Map</h2>

      <img id="heatmap-img" alt="Finviz Heatmap snapshot" />
      <div id="heatmap-missing" class="muted" style="display:none;margin-top:8px">
        Snapshot not found yet. It will appear after your update job writes
        <code>snapshots/finviz-heatmap.png</code>.
      </div>

      <div class="links">
        <a target="_blank" href="https://finviz.com/map.ashx">Open Heat Map Index →</a>
        <a target="_blank" href="https://money.cnn.com/data/fear-and-greed/">Open Fear &amp; Greed Index →</a>
      </div>
    </section>
  </main>

  <script>
    // ------------- Config -------------
    // The symbols you want to show, in order:
    const TICKERS = [
      "TSLA","TXN","WDAY","AAPL","AMD","AMZN","BA","BABA",
      "COST","DIS","GOOGL","INTC","IWM","META","MSFT","MU","NVDA"
    ];

    // Files written by your GitHub workflow (must live in docs/)
    const TICKER_JSON = "ticker-prices.json";                 // JSON with {updated, data:[{symbol,price,changePct,volume}]}
    const HEATMAP_PNG = "snapshots/finviz-heatmap.png";       // snapshot image path

    // ------------- Helpers -------------
    const $ = sel => document.querySelector(sel);

    function fmtPrice(x){
      if (x === undefined || x === null || Number.isNaN(x)) return "—";
      return Number(x).toFixed(2);
    }
    function fmtPct(x){
      if (x === undefined || x === null || Number.isNaN(x)) return "—";
      const v = Number(x);
      const sign = (v>0?"+":"") + v.toFixed(2) + "%";
      const cls = v>0 ? "up" : (v<0 ? "down" : "flat");
      return { sign, cls };
    }
    async function loadJSON(url){
      try{
        const r = await fetch(url + "?v=" + Date.now(), {cache:"no-store"});
        if(!r.ok) throw new Error(r.status + " " + r.statusText);
        return await r.json();
      }catch(e){
        return null;
      }
    }

    // ------------- Tickers -------------
    function renderTickerStrip(quotes){
      const bySym = new Map();
      (quotes?.data ?? []).forEach(q => bySym.set((q.symbol||"").toUpperCase(), q));

      const frag = document.createDocumentFragment();

      TICKERS.forEach(sym => {
        const q = bySym.get(sym) || {};
        const price = fmtPrice(q.price);
        const pct   = fmtPct(q.changePct ?? 0);

        const chip = document.createElement("div");
        chip.className = "chip";

        const left = document.createElement("div");
        left.style.display="flex";
        left.style.flexDirection="column";
        left.style.gap="2px";
        const s = document.createElement("div");
        s.className="sym"; s.textContent=sym;
        const p = document.createElement("div");
        p.className="price"; p.textContent=price;
        left.appendChild(s); left.appendChild(p);

        const right = document.createElement("div");
        right.className="pct " + pct.cls;
        right.textContent = pct.sign;

        chip.appendChild(left);
        chip.appendChild(right);

        frag.appendChild(chip);
      });

      const strip = $("#ticker-strip");
      strip.innerHTML = "";
      strip.appendChild(frag);

      // header timestamp
      const ts = (quotes && quotes.updated) ? new Date(quotes.updated) : new Date();
      $("#last-updated").textContent = "• Last updated " + ts.toLocaleString();
    }

    async function refreshTickers(){
      const data = await loadJSON(TICKER_JSON);
      renderTickerStrip(data);
    }

    // ------------- Heatmap -------------
    function refreshHeatmap(){
      const img = $("#heatmap-img");
      const miss = $("#heatmap-missing");
      // cache-bust to force GitHub Pages to fetch the newest image
      img.src = HEATMAP_PNG + "?v=" + Date.now();
      img.style.display = "block";
      miss.style.display = "none";

      // if the image 404s, show the friendly message
      img.onerror = () => {
        img.style.display = "none";
        miss.style.display = "block";
      };
    }

    // ------------- Init -------------
    (async function init(){
      await refreshTickers();
      refreshHeatmap();

      // Re-pull tickers every 60s; heat map every 5 min
      setInterval(refreshTickers, 60_000);
      setInterval(refreshHeatmap, 5 * 60_000);
    })();
  </script>
</body>
</html>
